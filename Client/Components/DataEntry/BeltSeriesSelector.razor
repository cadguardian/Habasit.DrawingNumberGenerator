@page "/belt-series"
@using DNG.Library.Models.BeltSpecs
@inject HttpClient Http
@inject IBeltSeriesService BeltSeriesService
@inject IStateContainer State

<div class="input-group mb-3">
    <div class="container px-4">
       

        <div class="col gx-5">
            <div class="col d-flex justify-content-center align-items-center">
                @if (State.DrawingRequest.ThumbnailImageFilePath != null)
                {
                    <img src="images/belts/@State.DrawingRequest.ThumbnailImageFilePath" alt="Belt Image" class="img-thumbnail m-4" style="max-width: 100%;" />
                }
                else if (!string.IsNullOrEmpty(State.DrawingRequest?.BeltSeries))
                {
                    <p class="text-danger">No image available for the selected belt series.</p>
                }
            </div>

            <div class="input-group mb-3">
                <div class="form-floating">
                    <select id="beltSeries" class="form-select form-select-sm"
                            @bind="beltSeries"
                            required>
                        <option value="" disabled selected>Select Belt Series</option>
                        @foreach (var series in BeltSeries.Options.Keys.OrderBy(_ => _))
                        {
                            <option value="@series">@series</option>
                        }
                    </select>
                    <label for="beltSeries">Series</label>
                </div>
                <span class="input-group-text">@BeltSeriesService.GetBeltSeriesType(State.DrawingRequest?.BeltSeries ?? "")</span>
            </div>
        </div>
    </div>
</div>

@code {
    @code {
        protected override void OnInitialized()
        {
            State.OnStateChange += StateHasChanged;
        }

        public void Dispose()
        {
            State.OnStateChange -= StateHasChanged;
        }
    }

    private void UpdateBeltSeriesCode(string series)
        {
    State.UpdateProperty(State.DrawingNumber, dn => dn.BeltSeriesCode = series);
        }

    private string beltSeries
    {
    get => State.DrawingRequest?.BeltSeries ?? string.Empty;
    set
    {
        if (State.DrawingRequest != null)
        {
            UpdateBeltSeries(value);
        }
    }
    }

    public void UpdateBeltSeries(string beltSeries)
        {
    State.UpdateProperty(State.DrawingRequest, dr => dr.BeltSeries = beltSeries);

    UpdateThumnailImageFilePath(beltSeries);

    UpdateBeltSeriesCode(beltSeries);
        }

    public void UpdateThumnailImageFilePath(string path)
        {
    State.UpdateProperty(State.DrawingRequest, dr => dr.ThumbnailImageFilePath = BeltSeriesService!.GetImageFileNameForBeltSeries(State.DrawingRequest.BeltSeries, imageFiles)!);
        }

    private List<string> imageFiles = new();

    protected override async Task OnInitializedAsync()
    {
        // Load image files with service
        imageFiles = await BeltSeriesService.LoadImageFilesAsync(Http);
    }
}
