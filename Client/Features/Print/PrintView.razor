@page "/project-summary"
@using DNG.Library.Models;
@inject IDrawingRequest DrawingRequest
@inject IDrawingNumber DrawingNumber
@inject IImageGalleryService ImageService
@inject HttpClient Http
@inject IJSRuntime JS

<div class="container-fluid">
    <!-- Summary Sheet Section (Hidden initially) -->
    <div class="summary-sheet print-mode" style="display: block;" id="summarySheet">
        <div class="text-center">

            <h3 class="display-6">Special Build - Plastic Modular Belt</h3>

            <div class="text-muted">Drawing Request - @DrawingRequest.GetProjectFolderName()</div>

            <p class="no-print">Printing this page will print the information below to track drawing.</p>

            <button class="btn btn-sm btn-primary mb-3 no-print" @onclick="ConfirmAndRefresh">Refresh Data</button>
        </div>
        
        <!-- MAIN SECTION: Two Columns -->
        <div class="row">
            <!-- LEFT COLUMN: Thumbnail Image and Basic Info -->
            <div class="col-md-6 col-sm-6">
                <div class="card mb-3">
                    <div class="card-header"><i class="fa-solid fa-user"></i> CSR Drawing Request</div>
                    <div class="card-body p-0">
                        @if (!string.IsNullOrWhiteSpace(DrawingRequest.StructuredText))
                        {
                            <div class="alert alert-success">
                                <p>@DrawingRequest.StructuredText</p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <p>Structured text is currently empty. Please complete the drawing request form to display CSR request (structured text).</p>
                            </div>
                        }
                    </div>

                  
                </div>
                <div class="card mb-3">
                    <div class="card-header"><i class="fa-solid fa-copy"></i> Title Block Information</div>
                    <div class="card-body">
                        <div>
                            <strong>Folder Name: </strong>
                            @if (!string.IsNullOrWhiteSpace(DrawingRequest.GetProjectFolderName()))
                            {
                                @DrawingRequest.GetProjectFolderName()
                            }
                            else
                            {
                                <span class="text-danger">❌</span>
                            }
                        </div>

                        <div><strong>Rev Number:</strong> A</div>

                        <div><strong>Drawn Date:</strong> @DateTime.Now.ToString("MM/dd/yyyy")</div>

                        <div><strong>Scale:</strong> N/A</div>

                        <div>
                            <strong>Drawn By:</strong> T SMITH
                        </div>

                        <div>
                            <strong>Job Number: </strong>
                            @if (!string.IsNullOrWhiteSpace(DrawingRequest.GetJobNumber()))
                            {
                                @DrawingRequest.GetJobNumber()
                            }
                            else
                            {
                                <span class="text-danger">❌</span>
                            }
                        </div>

                        <div>
                            <strong>Drawing Number: </strong>
                            @if (!string.IsNullOrWhiteSpace(DrawingNumber.GetDrawingNumber()))
                            {
                                @DrawingNumber.GetDrawingNumber()
                            }
                            else
                            {
                                <span class="text-danger">❌</span>
                            }
                        </div>
                    </div>
                </div>




                <div>
                    <div class="card mb-3">
                        <div class="card-header">CAD Template</div>
                        <div class="card-body">
                            @if (!string.IsNullOrWhiteSpace(DrawingRequest.CadTemplatePath))
                            {
                                <a href="@DrawingRequest.CadTemplatePath" target="_blank">@DrawingRequest.CadTemplatePath</a>
                            }
                            else
                            {
                                <p class="text-danger">No CAD Template available. Please complete the drawing request.</p>
                            }
                        </div>
                    </div>


                    <div class="card mb-3">
                        <div class="card-header">Reference Drawing</div>
                        <div class="card-body">
                            @if (!string.IsNullOrWhiteSpace(DrawingRequest.ReferenceDrawingPath))
                            {
                                <a href="@DrawingRequest.ReferenceDrawingPath" target="_blank">@DrawingRequest.ReferenceDrawingPath</a>
                            }
                            else
                            {
                                <p class="text-danger">No Reference Drawing available. Please complete the drawing request and configure the query string for wider results.</p>
                            }
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><i class="fa-regular fa-note-sticky"></i> Notes</div>
                        <div class="card-body">
                            <textarea class="form-control" rows="5" placeholder="Enter notes here..."></textarea>
                        </div>
                    </div>


                </div>
            </div>

            <!-- RIGHT COLUMN: Title Block Information -->
           


            <div class="col-md-6 col-sm-6">
                <div class="card mb-3">
                    <div class="card-header"><i class="fa-regular fa-image"></i> Thumbnail</div>
                    <div class="card-body d-flex align-items-center justify-content-center p-0">
                        <img src="images/belts/@GetThumbnailImage()" alt="Belt Thumbnail" class="img-fluid p-0 m-0" />
                    </div>


                </div>

                <DrawingDetailsTable />
            </div>

        
        </div>

        
        
    </div>
    <!-- PARTS LIST SECTION -->
    <div class="card mb-3 mt-4">
        <div class="card-header"><i class="fa-solid fa-list"></i> Available Parts</div>
        <div class="card-body d-flex align-items-center  p-0">
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Part Name</th>
                            <th>Description</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (DrawingRequest.PartsList != null && DrawingRequest.PartsList.Any())
                        {
                            @foreach (var part in DrawingRequest.PartsList)
                            {
                                <tr>
                                    <td>@part.Key</td>
                                    <td>@part.Value</td>
                                    <td><input type="number" class="form-control form-control-sm" placeholder="Qty" /></td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-danger">
                                    No parts available. Please complete the drawing request.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>

</div>

@code {
    private List<string> imageFiles = new();

    private string searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        imageFiles = await ImageService.LoadImageFilesAsync();
    }

    private IEnumerable<string> FilteredImages => ImageService.FilterImages(imageFiles, searchQuery);

    private async Task ConfirmAndRefresh()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to refresh? Any unsaved changes will be lost.");
        if (confirmed)
        {
            StateHasChanged();
        }
    }


    private void ApplyFilters()
    {
        // Update searchQuery based on filter criteria, for example:
        searchQuery = !string.IsNullOrWhiteSpace(DrawingRequest.BeltType) ? DrawingRequest.BeltSeries : string.Empty;
    }

    private string GetThumbnailImage() => FilteredImages.FirstOrDefault()!;
    
}
